# GitHub Actions Deploy to DOKS Workflow
# Per T050-T051: Build, push to DOCR, and deploy to DOKS

name: Deploy to DOKS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: registry.digitalocean.com
  REGISTRY_NAME: ${{ secrets.DOCR_REGISTRY_NAME }}
  CLUSTER_NAME: ${{ secrets.DOKS_CLUSTER_NAME }}
  HELM_RELEASE: todo-chatbot
  NAMESPACE: production

jobs:
  # Build and push all images
  build-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DOCR
        run: doctl registry login --expiry-seconds 3600

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Backend
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-backend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Frontend
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-frontend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.PRODUCTION_API_URL }}
            NEXT_PUBLIC_WS_URL=${{ secrets.PRODUCTION_WS_URL }}

      # Build Microservices
      - name: Build and push websocket-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/websocket
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/websocket-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/websocket-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push recurring-task-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/recurring-task
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/recurring-task-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/recurring-task-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push notification-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/notification
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/notification-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/notification-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to DOKS
  deploy:
    name: Deploy to DOKS
    runs-on: ubuntu-latest
    needs: build-push
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get kubeconfig
        run: doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Create namespace
        run: kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Helm chart
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./helm/todo-chatbot \
            --namespace ${{ env.NAMESPACE }} \
            --values ./helm/todo-chatbot/values-doks.yaml \
            --set global.imageTag=${{ needs.build-push.outputs.image_tag }} \
            --set global.registry=${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }} \
            --set secrets.databaseUrl="${{ secrets.DATABASE_URL }}" \
            --set secrets.betterAuthSecret="${{ secrets.BETTER_AUTH_SECRET }}" \
            --set secrets.openaiApiKey="${{ secrets.OPENAI_API_KEY }}" \
            --set secrets.redpandaUsername="${{ secrets.REDPANDA_USERNAME }}" \
            --set secrets.redpandaPassword="${{ secrets.REDPANDA_PASSWORD }}" \
            --set config.redpandaBrokers="${{ secrets.REDPANDA_BROKERS }}" \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          echo "Checking deployment status..."
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-backend -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-frontend -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-websocket -n ${{ env.NAMESPACE }} --timeout=5m
          echo "All deployments ready!"

      - name: Get service endpoints
        run: |
          echo "=== Service Endpoints ==="
          kubectl get ingress -n ${{ env.NAMESPACE }}
          kubectl get services -n ${{ env.NAMESPACE }}

  # Smoke test
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Health check
        run: |
          echo "Running health checks..."
          # Backend health
          curl -sf "${{ secrets.PRODUCTION_API_URL }}/api/health" || exit 1
          echo "Backend: OK"
          # Frontend health
          curl -sf "${{ secrets.PRODUCTION_URL }}/" || exit 1
          echo "Frontend: OK"
          echo "All health checks passed!"

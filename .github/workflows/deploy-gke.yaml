# GitHub Actions Deploy to Google Cloud GKE Workflow
# Builds images, pushes to Artifact Registry, and deploys to GKE
#
# Required GitHub Secrets:
#   GCP_PROJECT_ID      - Google Cloud project ID
#   GCP_SA_KEY          - Service account JSON key (base64-encoded)
#   GKE_CLUSTER_NAME    - GKE cluster name
#   GKE_CLUSTER_ZONE    - Cluster zone (e.g., us-central1-a)
#   GAR_LOCATION        - Artifact Registry region (e.g., us-central1)
#   DATABASE_URL         - PostgreSQL connection string
#   BETTER_AUTH_SECRET   - Auth secret key
#   OPENAI_API_KEY       - OpenAI API key
#   REDPANDA_BROKERS     - Redpanda broker addresses
#   REDPANDA_USERNAME    - Redpanda SASL username
#   REDPANDA_PASSWORD    - Redpanda SASL password

name: Deploy to GKE

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
  REGISTRY: ${{ secrets.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/todo-chatbot
  HELM_RELEASE: todo-chatbot
  K8S_NAMESPACE: production

jobs:
  # Build and push all images to Google Artifact Registry
  build-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Backend (amd64)
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/todo-backend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/todo-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Frontend
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/todo-frontend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/todo-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build WebSocket Service
      - name: Build and push websocket-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/websocket
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/websocket-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/websocket-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Recurring Task Service
      - name: Build and push recurring-task-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/recurring-task
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/recurring-task-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/recurring-task-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Notification Service
      - name: Build and push notification-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/notification
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/notification-service:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/notification-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to GKE
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-push
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_CLUSTER_ZONE }}

      - name: Verify cluster connection
        run: kubectl get nodes

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Create namespace
        run: kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Artifact Registry pull secret
        run: |
          kubectl create secret docker-registry gar-secret \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --docker-server=${{ env.GAR_LOCATION }}-docker.pkg.dev \
            --docker-username=_json_key \
            --docker-password='${{ secrets.GCP_SA_KEY }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Redpanda credentials secret
        run: |
          kubectl create secret generic redpanda-credentials \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --from-literal=brokers='${{ secrets.REDPANDA_BROKERS }}' \
            --from-literal=saslUsername='${{ secrets.REDPANDA_USERNAME }}' \
            --from-literal=saslPassword='${{ secrets.REDPANDA_PASSWORD }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Helm chart
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE }} ./helm/todo-chatbot \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --values ./helm/values-gke.yaml \
            --set global.imageTag=${{ needs.build-push.outputs.image_tag }} \
            --set global.registry=${{ env.REGISTRY }} \
            --set secrets.databaseUrl="${{ secrets.DATABASE_URL }}" \
            --set secrets.betterAuthSecret="${{ secrets.BETTER_AUTH_SECRET }}" \
            --set secrets.openaiApiKey="${{ secrets.OPENAI_API_KEY }}" \
            --set dapr.pubsub.brokers="${{ secrets.REDPANDA_BROKERS }}" \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          echo "Checking deployment status..."
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-backend -n ${{ env.K8S_NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-frontend -n ${{ env.K8S_NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-websocket -n ${{ env.K8S_NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/${{ env.HELM_RELEASE }}-redis -n ${{ env.K8S_NAMESPACE }} --timeout=5m
          echo "All deployments ready!"

      - name: Get service endpoints
        run: |
          echo "=== Service Endpoints ==="
          kubectl get ingress -n ${{ env.K8S_NAMESPACE }}
          kubectl get services -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}

  # Smoke test
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Get LoadBalancer IP
        id: lb
        run: |
          echo "Smoke tests require manual verification."
          echo "Run: kubectl get svc -n ingress-nginx"
          echo "Then: curl http://<LB_IP>/api/health"

      - name: Basic connectivity check
        run: |
          echo "Deployment completed successfully."
          echo "Verify manually:"
          echo "  1. kubectl get pods -n production"
          echo "  2. kubectl get svc -n ingress-nginx"
          echo "  3. curl http://<LB_IP>/api/health"

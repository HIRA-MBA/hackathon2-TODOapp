# Docker Compose - Application Services with Dapr Sidecars
# Includes backend, frontend, and microservices

services:
  # ========================================
  # Backend Service + Dapr Sidecar
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL:-http://localhost:3000}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      - MCP_DEFAULT_USER_ID=${MCP_DEFAULT_USER_ID:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    ports:
      - "8000:8000"
    # Note: Start docker-compose.infra.yaml first for redpanda/redis
    networks:
      - todo-network

  backend-dapr:
    image: daprio/daprd:latest
    container_name: backend-dapr
    command:
      - "./daprd"
      - "-app-id"
      - "backend"
      - "-app-port"
      - "8000"
      - "-dapr-http-port"
      - "3500"
      - "-dapr-grpc-port"
      - "50001"
      - "-components-path"
      - "/components"
      - "-config"
      - "/config/config.yaml"
    volumes:
      - ./dapr/components:/components:ro
      - ./dapr:/config:ro
    network_mode: "service:backend"
    depends_on:
      - backend

  # ========================================
  # Frontend Service
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_WS_URL=ws://localhost:8001
      - NEXT_PUBLIC_BETTER_AUTH_URL=http://localhost:3000
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - DATABASE_URL=${FRONTEND_DATABASE_URL}
      - BACKEND_URL=http://backend:8000
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - todo-network

  # ========================================
  # WebSocket Service + Dapr Sidecar
  # ========================================
  websocket-service:
    build:
      context: ./services/websocket
      dockerfile: Dockerfile
    container_name: websocket-service
    environment:
      - JWT_SECRET=${JWT_SECRET:-}
      - BACKEND_URL=http://backend:8000
    ports:
      - "8001:8001"
    # Note: Start docker-compose.infra.yaml first for redpanda
    networks:
      - todo-network

  websocket-dapr:
    image: daprio/daprd:latest
    container_name: websocket-dapr
    command:
      - "./daprd"
      - "-app-id"
      - "websocket-service"
      - "-app-port"
      - "8001"
      - "-dapr-http-port"
      - "3500"
      - "-components-path"
      - "/components"
      - "-config"
      - "/config/config.yaml"
    volumes:
      - ./dapr/components:/components:ro
      - ./dapr:/config:ro
    network_mode: "service:websocket-service"
    depends_on:
      - websocket-service

  # ========================================
  # Recurring Task Service + Dapr Sidecar
  # ========================================
  recurring-task-service:
    build:
      context: ./services/recurring-task
      dockerfile: Dockerfile
    container_name: recurring-task-service
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - BACKEND_URL=http://backend:8000
    # Note: Start docker-compose.infra.yaml first for redpanda
    networks:
      - todo-network

  recurring-task-dapr:
    image: daprio/daprd:latest
    container_name: recurring-task-dapr
    command:
      - "./daprd"
      - "-app-id"
      - "recurring-task-service"
      - "-app-port"
      - "8002"
      - "-dapr-http-port"
      - "3500"
      - "-components-path"
      - "/components"
      - "-config"
      - "/config/config.yaml"
    volumes:
      - ./dapr/components:/components:ro
      - ./dapr:/config:ro
    network_mode: "service:recurring-task-service"
    depends_on:
      - recurring-task-service

  # ========================================
  # Notification Service + Dapr Sidecar
  # ========================================
  notification-service:
    build:
      context: ./services/notification
      dockerfile: Dockerfile
    container_name: notification-service
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - BACKEND_URL=http://backend:8000
    # Note: Start docker-compose.infra.yaml first for redpanda
    networks:
      - todo-network

  notification-dapr:
    image: daprio/daprd:latest
    container_name: notification-dapr
    command:
      - "./daprd"
      - "-app-id"
      - "notification-service"
      - "-app-port"
      - "8003"
      - "-dapr-http-port"
      - "3500"
      - "-components-path"
      - "/components"
      - "-config"
      - "/config/config.yaml"
    volumes:
      - ./dapr/components:/components:ro
      - ./dapr:/config:ro
    network_mode: "service:notification-service"
    depends_on:
      - notification-service

networks:
  todo-network:
    external: true
    name: hackathone2_todo-network

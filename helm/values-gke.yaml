# Google Cloud GKE Production Values
# Usage: helm upgrade --install todo-chatbot ./helm/todo-chatbot -f helm/values-gke.yaml

# Global configuration
global:
  environment: production
  imageTag: latest  # Override with specific tag in CI/CD
  imagePullPolicy: Always
  # Google Artifact Registry (GAR)
  # Format: <region>-docker.pkg.dev/<project-id>/<repo-name>
  registry: us-central1-docker.pkg.dev/my-project/my-repo
  imagePullSecrets:
    - name: gar-secret

# Frontend configuration
frontend:
  replicaCount: 1
  image:
    repository: todo-frontend
  service:
    type: ClusterIP
    port: 80
    targetPort: 3000
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"
  probes:
    liveness:
      path: /
      initialDelaySeconds: 15
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
    readiness:
      path: /
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    startup:
      path: /
      failureThreshold: 30
      periodSeconds: 10
      timeoutSeconds: 10

# Backend configuration
backend:
  replicaCount: 1
  image:
    repository: todo-backend
  service:
    type: ClusterIP
    port: 8000
    targetPort: 8000
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  probes:
    liveness:
      path: /api/health
      initialDelaySeconds: 30
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
    readiness:
      path: /api/health
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 10
      failureThreshold: 3
    startup:
      path: /api/health
      failureThreshold: 30
      periodSeconds: 10
      timeoutSeconds: 15

# WebSocket service configuration
websocket:
  enabled: true
  replicaCount: 1
  image:
    repository: websocket-service
  service:
    type: ClusterIP
    port: 8001
    targetPort: 8001
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"
  probes:
    liveness:
      path: /health
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: /health
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

# Recurring task service configuration
recurringTask:
  enabled: true
  replicaCount: 1
  image:
    repository: recurring-task-service
  service:
    type: ClusterIP
    port: 8002
    targetPort: 8002
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"
  probes:
    liveness:
      path: /health
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: /health
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

# Notification service configuration
notification:
  enabled: true
  replicaCount: 1
  image:
    repository: notification-service
  service:
    type: ClusterIP
    port: 8003
    targetPort: 8003
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"
  probes:
    liveness:
      path: /health
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: /health
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

# Ingress configuration for GKE
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    # WebSocket support
    nginx.ingress.kubernetes.io/websocket-services: "todo-chatbot-websocket"
  hosts:
    - host: ""  # Leave empty to use LoadBalancer IP directly
      paths:
        - path: /
          pathType: Prefix
          service: frontend
        - path: /api
          pathType: Prefix
          service: backend
        - path: /ws
          pathType: Prefix
          service: websocket
  tls: []  # Add TLS later with cert-manager if needed

# ConfigMap values for GKE
config:
  environment: production
  appName: "Todo App"
  corsOrigins: "*"  # Update with actual domain when available
  betterAuthUrl: "http://todo-chatbot-frontend:80"
  backendUrl: "http://todo-chatbot-backend:8000"
  chatkitWorkflowId: ""
  mcpDefaultUserId: ""
  betterAuthTrustedOrigins: "*"  # Update with actual domain when available

# Secrets (provide via kubectl create secret or CI/CD --set)
secrets:
  databaseUrl: ""
  betterAuthSecret: ""
  openaiApiKey: ""
  mcpApiKey: ""
  openaiDomainKey: ""

# Dapr configuration for GKE
dapr:
  enabled: true
  pubsub:
    # Redpanda Serverless configuration (SASL_SSL)
    brokers: ""  # e.g., "seed-xxxxx.redpanda.com:9092"
    consumerGroup: "todo-chatbot-prod"
    authType: "password"
    saslMechanism: "SCRAM-SHA-256"
    tlsEnabled: true
    tlsSkipVerify: false
    maxMessageBytes: "1048576"
    initialOffset: "newest"
    secretRef: "redpanda-credentials"
  statestore:
    # In-cluster Redis (no TLS, no password)
    inCluster: true
    redisHost: ""  # Auto-resolved from release name when inCluster=true
    redisPassword: ""
    enableTLS: false
    actorStateStore: "true"
    keyPrefix: "todo-prod"
    secretRef: ""
  secretstore:
    enabled: true

# In-cluster Redis (self-hosted)
redis:
  enabled: true
  image:
    repository: redis
    tag: 7-alpine
    pullPolicy: IfNotPresent
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"
  probes:
    liveness:
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 3
    readiness:
      initialDelaySeconds: 3
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
  persistence:
    enabled: true
    storageClass: "standard-rwo"  # GKE default persistent disk
    size: "5Gi"
